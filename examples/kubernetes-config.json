{
  "apiVersion": "v1",
  "kind": "List",
  "items": [
    {
      "apiVersion": "v1",
      "kind": "Namespace",
      "metadata": {
        "name": "production",
        "labels": {
          "environment": "production",
          "team": "platform"
        }
      }
    },
    {
      "apiVersion": "v1",
      "kind": "ConfigMap",
      "metadata": {
        "name": "app-config",
        "namespace": "production"
      },
      "data": {
        "app.properties": "environment=production\nlog.level=info\nmax.connections=100\n",
        "database.url": "postgresql://db.example.com:5432/appdb",
        "redis.host": "redis.example.com",
        "redis.port": "6379"
      }
    },
    {
      "apiVersion": "v1",
      "kind": "Secret",
      "metadata": {
        "name": "app-secrets",
        "namespace": "production"
      },
      "type": "Opaque",
      "data": {
        "database-password": "cGFzc3dvcmQxMjM=",
        "api-key": "YXBpa2V5MTIzNDU2Nzg5MA==",
        "jwt-secret": "and0c2VjcmV0a2V5MTIzNDU2"
      }
    },
    {
      "apiVersion": "v1",
      "kind": "PersistentVolumeClaim",
      "metadata": {
        "name": "app-storage",
        "namespace": "production"
      },
      "spec": {
        "accessModes": ["ReadWriteOnce"],
        "resources": {
          "requests": {
            "storage": "10Gi"
          }
        },
        "storageClassName": "fast-ssd"
      }
    },
    {
      "apiVersion": "apps/v1",
      "kind": "Deployment",
      "metadata": {
        "name": "web-app",
        "namespace": "production",
        "labels": {
          "app": "web-app",
          "version": "v1.2.3"
        }
      },
      "spec": {
        "replicas": 3,
        "strategy": {
          "type": "RollingUpdate",
          "rollingUpdate": {
            "maxSurge": 1,
            "maxUnavailable": 0
          }
        },
        "selector": {
          "matchLabels": {
            "app": "web-app"
          }
        },
        "template": {
          "metadata": {
            "labels": {
              "app": "web-app",
              "version": "v1.2.3"
            },
            "annotations": {
              "prometheus.io/scrape": "true",
              "prometheus.io/port": "8080",
              "prometheus.io/path": "/metrics"
            }
          },
          "spec": {
            "serviceAccountName": "web-app-sa",
            "containers": [
              {
                "name": "web-app",
                "image": "example.com/web-app:v1.2.3",
                "imagePullPolicy": "IfNotPresent",
                "ports": [
                  {
                    "name": "http",
                    "containerPort": 8080,
                    "protocol": "TCP"
                  },
                  {
                    "name": "metrics",
                    "containerPort": 9090,
                    "protocol": "TCP"
                  }
                ],
                "env": [
                  {
                    "name": "ENVIRONMENT",
                    "value": "production"
                  },
                  {
                    "name": "DATABASE_URL",
                    "valueFrom": {
                      "configMapKeyRef": {
                        "name": "app-config",
                        "key": "database.url"
                      }
                    }
                  },
                  {
                    "name": "DATABASE_PASSWORD",
                    "valueFrom": {
                      "secretKeyRef": {
                        "name": "app-secrets",
                        "key": "database-password"
                      }
                    }
                  },
                  {
                    "name": "API_KEY",
                    "valueFrom": {
                      "secretKeyRef": {
                        "name": "app-secrets",
                        "key": "api-key"
                      }
                    }
                  }
                ],
                "resources": {
                  "requests": {
                    "cpu": "250m",
                    "memory": "512Mi"
                  },
                  "limits": {
                    "cpu": "1000m",
                    "memory": "1Gi"
                  }
                },
                "livenessProbe": {
                  "httpGet": {
                    "path": "/health/live",
                    "port": 8080,
                    "scheme": "HTTP"
                  },
                  "initialDelaySeconds": 30,
                  "periodSeconds": 10,
                  "timeoutSeconds": 5,
                  "successThreshold": 1,
                  "failureThreshold": 3
                },
                "readinessProbe": {
                  "httpGet": {
                    "path": "/health/ready",
                    "port": 8080,
                    "scheme": "HTTP"
                  },
                  "initialDelaySeconds": 10,
                  "periodSeconds": 5,
                  "timeoutSeconds": 3,
                  "successThreshold": 1,
                  "failureThreshold": 3
                },
                "volumeMounts": [
                  {
                    "name": "app-storage",
                    "mountPath": "/var/lib/app/data"
                  },
                  {
                    "name": "config-volume",
                    "mountPath": "/etc/app/config"
                  }
                ]
              },
              {
                "name": "sidecar-logger",
                "image": "example.com/logger:v1.0.0",
                "resources": {
                  "requests": {
                    "cpu": "50m",
                    "memory": "128Mi"
                  },
                  "limits": {
                    "cpu": "100m",
                    "memory": "256Mi"
                  }
                },
                "volumeMounts": [
                  {
                    "name": "app-storage",
                    "mountPath": "/var/log/app",
                    "subPath": "logs"
                  }
                ]
              }
            ],
            "volumes": [
              {
                "name": "app-storage",
                "persistentVolumeClaim": {
                  "claimName": "app-storage"
                }
              },
              {
                "name": "config-volume",
                "configMap": {
                  "name": "app-config"
                }
              }
            ],
            "affinity": {
              "podAntiAffinity": {
                "preferredDuringSchedulingIgnoredDuringExecution": [
                  {
                    "weight": 100,
                    "podAffinityTerm": {
                      "labelSelector": {
                        "matchExpressions": [
                          {
                            "key": "app",
                            "operator": "In",
                            "values": ["web-app"]
                          }
                        ]
                      },
                      "topologyKey": "kubernetes.io/hostname"
                    }
                  }
                ]
              }
            }
          }
        }
      }
    },
    {
      "apiVersion": "v1",
      "kind": "Service",
      "metadata": {
        "name": "web-app-service",
        "namespace": "production",
        "labels": {
          "app": "web-app"
        }
      },
      "spec": {
        "type": "LoadBalancer",
        "selector": {
          "app": "web-app"
        },
        "ports": [
          {
            "name": "http",
            "protocol": "TCP",
            "port": 80,
            "targetPort": 8080
          },
          {
            "name": "https",
            "protocol": "TCP",
            "port": 443,
            "targetPort": 8080
          }
        ],
        "sessionAffinity": "ClientIP",
        "sessionAffinityConfig": {
          "clientIP": {
            "timeoutSeconds": 10800
          }
        }
      }
    },
    {
      "apiVersion": "networking.k8s.io/v1",
      "kind": "Ingress",
      "metadata": {
        "name": "web-app-ingress",
        "namespace": "production",
        "annotations": {
          "kubernetes.io/ingress.class": "nginx",
          "cert-manager.io/cluster-issuer": "letsencrypt-prod",
          "nginx.ingress.kubernetes.io/ssl-redirect": "true",
          "nginx.ingress.kubernetes.io/rate-limit": "100"
        }
      },
      "spec": {
        "tls": [
          {
            "hosts": ["app.example.com"],
            "secretName": "web-app-tls"
          }
        ],
        "rules": [
          {
            "host": "app.example.com",
            "http": {
              "paths": [
                {
                  "path": "/",
                  "pathType": "Prefix",
                  "backend": {
                    "service": {
                      "name": "web-app-service",
                      "port": {
                        "number": 80
                      }
                    }
                  }
                }
              ]
            }
          }
        ]
      }
    },
    {
      "apiVersion": "autoscaling/v2",
      "kind": "HorizontalPodAutoscaler",
      "metadata": {
        "name": "web-app-hpa",
        "namespace": "production"
      },
      "spec": {
        "scaleTargetRef": {
          "apiVersion": "apps/v1",
          "kind": "Deployment",
          "name": "web-app"
        },
        "minReplicas": 3,
        "maxReplicas": 10,
        "metrics": [
          {
            "type": "Resource",
            "resource": {
              "name": "cpu",
              "target": {
                "type": "Utilization",
                "averageUtilization": 70
              }
            }
          },
          {
            "type": "Resource",
            "resource": {
              "name": "memory",
              "target": {
                "type": "Utilization",
                "averageUtilization": 80
              }
            }
          }
        ],
        "behavior": {
          "scaleDown": {
            "stabilizationWindowSeconds": 300,
            "policies": [
              {
                "type": "Percent",
                "value": 50,
                "periodSeconds": 60
              }
            ]
          },
          "scaleUp": {
            "stabilizationWindowSeconds": 0,
            "policies": [
              {
                "type": "Percent",
                "value": 100,
                "periodSeconds": 30
              },
              {
                "type": "Pods",
                "value": 2,
                "periodSeconds": 30
              }
            ],
            "selectPolicy": "Max"
          }
        }
      }
    },
    {
      "apiVersion": "v1",
      "kind": "ServiceAccount",
      "metadata": {
        "name": "web-app-sa",
        "namespace": "production"
      }
    },
    {
      "apiVersion": "rbac.authorization.k8s.io/v1",
      "kind": "Role",
      "metadata": {
        "name": "web-app-role",
        "namespace": "production"
      },
      "rules": [
        {
          "apiGroups": [""],
          "resources": ["configmaps", "secrets"],
          "verbs": ["get", "list"]
        }
      ]
    },
    {
      "apiVersion": "rbac.authorization.k8s.io/v1",
      "kind": "RoleBinding",
      "metadata": {
        "name": "web-app-rolebinding",
        "namespace": "production"
      },
      "roleRef": {
        "apiGroup": "rbac.authorization.k8s.io",
        "kind": "Role",
        "name": "web-app-role"
      },
      "subjects": [
        {
          "kind": "ServiceAccount",
          "name": "web-app-sa",
          "namespace": "production"
        }
      ]
    }
  ]
}
